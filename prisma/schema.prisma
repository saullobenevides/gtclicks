// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url       = env("DATABASE_URL")
  // directUrl = env("DIRECT_DATABASE_URL") // Only for Neon pooling in production
}

// --- USUÁRIOS ---

enum UserRole {
  CLIENTE
  FOTOGRAFO
  ADMIN
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  image         String?
  role          UserRole  @default(CLIENTE)
  createdAt     DateTime  @default(now())
  isActive      Boolean   @default(true)
  suspendedAt   DateTime?
  suspendedBy   String?
  adminNotes    String?
  
  fotografo     Fotografo?
  pedidos       Pedido[]
  carrinho      Carrinho?
  likes         Like[]
  notifications Notification[]
  usageLogs     UsageLog[]
}

model Fotografo {
  id             String    @id @default(cuid())
  userId         String    @unique
  user           User      @relation(fields: [userId], references: [id])
  
  username       String    @unique
  bio            String?
  telefone       String?
  cidade         String?
  estado         String?
  instagram      String?
  portfolioUrl   String?
  chavePix       String?
  cpf            String?   @unique
  especialidades String[]
  equipamentos   String?
  
  fotos          Foto[]
  colecoes       Colecao[]
  saldo          Saldo?
  transacoes     Transacao[]
  saques         SolicitacaoSaque[]
}

// --- PRODUTOS (FOTOS) ---

enum OrientacaoFoto {
  HORIZONTAL
  VERTICAL
  QUADRADO
  PANORAMICA
}

enum FotoStatus {
  PENDENTE
  PUBLICADA
  REJEITADA
}

enum FaceIndexingStatus {
  PENDENTE
  INDEXED
  FAILED
}

model Foto {
  id             String    @id @default(cuid())
  
  // Descritivo
  titulo         String
  descricao      String?
  orientacao     OrientacaoFoto
  likes          Int       @default(0)
  views          Int       @default(0) // Analytics: Detail Views
  vendas         Int       @default(0) // Analytics: Total Sales count
  downloads      Int       @default(0) // Analytics: Total Downloads count
  carrinhoCount  Int       @default(0) // Analytics: Added to Cart count
  numeroSequencial Int?    // Busca: "Foto 231"
  sequentialId   Int       @unique @default(autoincrement()) // ID único global
  categoriaFoto  String?   // Busca: "Individual", "Grupo"
  
  // Técnico (Crítico para S3 e Next/Image)
  s3Key          String    @unique // Caminho privado no S3
  width          Int
  height         Int
  formato        String
  tamanhoBytes   Int
  previewUrl     String    // URL pública (Thumbnail)
  
  // Metadados EXIF
  camera         String?   // Ex: Canon EOS R5
  lens           String?   // Ex: 50mm f/1.2
  focalLength    String?   // Ex: 50mm
  iso            Int?      // Ex: 100
  shutterSpeed   String?   // Ex: 1/200
  aperture       String?   // Ex: f/2.8
  
  status         FotoStatus @default(PENDENTE)
  indexingStatus FaceIndexingStatus @default(PENDENTE)
  indexedFaceIds String[]
  
  fotografoId    String
  fotografo      Fotografo @relation(fields: [fotografoId], references: [id])
  
  colecaoId      String?
  colecao        Colecao?  @relation(fields: [colecaoId], references: [id])

  folderId       String?
  folder         Folder?   @relation(fields: [folderId], references: [id])

  licencas       FotoLicenca[]
  itensPedido    ItemPedido[]
  itensCarrinho  ItemCarrinho[]
  likesList      Like[]
  
  createdAt      DateTime  @default(now())
  
  @@index([colecaoId])
  @@index([fotografoId])
  @@index([status, createdAt])
  @@index([indexingStatus])
}

model Like {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  fotoId    String
  foto      Foto     @relation(fields: [fotoId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, fotoId])
}

enum ColecaoStatus {
  RASCUNHO
  PUBLICADA
}

model Colecao {
  id             String    @id @default(cuid())
  nome           String
  slug           String    @unique
  descricao      String?
  capaUrl        String?
  categoria      String?
  status         ColecaoStatus @default(RASCUNHO)
  precoFoto      Decimal   @default(0.0) @db.Decimal(10, 2)
  descontos      Json?     // Ex: [{"min": 5, "price": 10.0}]
  faceRecognitionEnabled Boolean @default(false)
  
  // Localização e Data
  cidade         String?
  estado         String?
  local          String?
  dataInicio     DateTime?
  dataFim        DateTime?

  views          Int       @default(0) // Analytics: Total Views
  vendas         Int       @default(0) // Analytics: Total Sales count
  downloads      Int       @default(0) // Analytics: Total Downloads count
  carrinhoCount  Int       @default(0) // Analytics: Added to Cart count
  
  fotografoId    String
  fotografo      Fotografo @relation(fields: [fotografoId], references: [id])
  
  fotos          Foto[]
  folders        Folder[]
  createdAt      DateTime  @default(now())
  
  @@index([fotografoId])
  @@index([status, createdAt])
  @@index([slug])
  @@index([categoria, status])
}

model Folder {
  id          String   @id @default(cuid())
  nome        String
  
  colecaoId   String
  colecao     Colecao  @relation(fields: [colecaoId], references: [id], onDelete: Cascade)
  
  parentId    String?
  parent      Folder?  @relation("FolderToFolder", fields: [parentId], references: [id])
  children    Folder[] @relation("FolderToFolder")
  
  fotos       Foto[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}


// --- LICENCIAMENTO ---

model Licenca {
  id             String    @id @default(cuid())
  nome           String    // Ex: "Uso Pessoal", "Comercial"
  descricao      String?
  termos         String    @db.Text
  
  fotos          FotoLicenca[]
  itensCarrinho  ItemCarrinho[]
  itensPedido    ItemPedido[]
}

model FotoLicenca {
  id             String    @id @default(cuid())
  preco          Decimal   @db.Decimal(10, 2)
  
  fotoId         String
  foto           Foto      @relation(fields: [fotoId], references: [id], onDelete: Cascade)
  
  licencaId      String
  licenca        Licenca   @relation(fields: [licencaId], references: [id])

  @@unique([fotoId, licencaId])
}

// --- CARRINHO E PEDIDOS ---

model Carrinho {
  id        String         @id @default(cuid())
  userId    String         @unique
  user      User           @relation(fields: [userId], references: [id])
  itens     ItemCarrinho[]
  updatedAt DateTime       @updatedAt
}

model ItemCarrinho {
  id          String   @id @default(cuid())
  carrinhoId  String
  carrinho    Carrinho @relation(fields: [carrinhoId], references: [id])
  
  fotoId      String
  foto        Foto     @relation(fields: [fotoId], references: [id], onDelete: Cascade)
  licencaId   String?
  licenca     Licenca? @relation(fields: [licencaId], references: [id])

  @@unique([carrinhoId, fotoId])
}

enum PedidoStatus {
  PENDENTE
  PAGO
  CANCELADO
}

model Pedido {
  id              String       @id @default(cuid())
  userId          String
  user            User         @relation(fields: [userId], references: [id])
  
  total           Decimal      @db.Decimal(10, 2)
  status          PedidoStatus @default(PENDENTE)
  paymentId       String?
  
  itens           ItemPedido[]
  createdAt       DateTime     @default(now())
  
  @@index([userId, status])
  @@index([createdAt])
  @@index([status])
}

model ItemPedido {
  id              String    @id @default(cuid())
  pedidoId        String
  pedido          Pedido    @relation(fields: [pedidoId], references: [id])
  
  fotoId          String
  foto            Foto      @relation(fields: [fotoId], references: [id])
  licencaId       String?
  licenca         Licenca?  @relation(fields: [licencaId], references: [id])
  
  precoPago       Decimal   @db.Decimal(10, 2) // Preço congelado
  
  // Segurança
  downloadToken   String    @default(cuid())
  downloadsCount  Int       @default(0)
}

// --- FINANCEIRO ---

model Saldo {
  id             String    @id @default(cuid())
  fotografoId    String    @unique
  fotografo      Fotografo @relation(fields: [fotografoId], references: [id])
  
  disponivel     Decimal   @default(0) @db.Decimal(10, 2)
  bloqueado      Decimal   @default(0) @db.Decimal(10, 2)
}

model Transacao {
  id             String    @id @default(cuid())
  fotografoId    String
  fotografo      Fotografo @relation(fields: [fotografoId], references: [id])
  
  valor          Decimal   @db.Decimal(10, 2)
  tipo           String    // VENDA, COMISSAO, SAQUE
  descricao      String?
  status         String?   // PENDENTE, PROCESSADO, FALHOU
  
  saqueId        String?
  saque          SolicitacaoSaque? @relation(fields: [saqueId], references: [id])
  
  createdAt      DateTime  @default(now())
}

model SolicitacaoSaque {
  id             String    @id @default(cuid())
  fotografoId    String
  fotografo      Fotografo @relation(fields: [fotografoId], references: [id])
  
  valor          Decimal
  chavePix       String?   // Audit trail: Key used at the time of request
  status         String    // PENDENTE, PAGO, CANCELADO, PROCESSADO
  processadoEm   DateTime?
  observacao     String?
  
  transacoes     Transacao[]
  
  createdAt      DateTime  @default(now())
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  
  title     String
  message   String
  read      Boolean  @default(false)
  type      String   // INFO, SUCCESS, WARNING, ERROR
  link      String?  // Optional link to action
  
  createdAt DateTime @default(now())
  
  @@index([userId, read])
}

model VerificationCode {
  id        String   @id @default(cuid())
  email     String
  code      String
  type      String   // PIX_UPDATE, etc.
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([email, code])
}

model SystemConfig {
  key         String @id
  value       String
  description String?
  updatedAt   DateTime @updatedAt
}

model UsageLog {
  id        String   @id @default(cuid())
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])
  action    String   // Ex: "SELFIE_SEARCH", "FACE_INDEXING"
  metadata  Json?
  createdAt DateTime @default(now())

  @@index([userId, action, createdAt])
}
